## Маршрутизация. Пример
<img src="../misc/images/network_route.png" alt="network_route" width="500"/>

Давайте рассмотрим (на иллюстрации) пример инфраструктуры с несколькими подсетями.

Как видно в примере ниже, первая запись (строка) указана для сети *128.17.75*, все пакеты для данной сети будут отправлены на шлюз *128.17.75.20*,
который является IP адресом самого хоста. Вторая запись - это маршрут по умолчанию, который применяется ко всем пакетам, посылаемым в сети,
не указанные в данной таблице маршрутизации. Здесь маршрут лежит через хост papaya (IP *128.17.75.98*), который можно считать дверью во внешний мир.
Данный маршрут должен быть прописан на всех машинах сети *128.17.75*, которые должны иметь доступ к другим сетям.
Третья запись создана для петлевого интерфейса. Данный адрес используется, если машине необходимо подключиться к самой себе по протоколу **TCP/IP**.
Последняя запись в таблице маршрутизации сделана для IP *128.17.75.20* и направляется на интерфейс lo,
т.о. при подключении машины к самой себе на адрес *128.17.75.20*, все пакеты будут посылаться на интерфейс *127.0.0.1*.

Пример таблицы маршрутизации для хоста eggplant:
```
[root@eggplant ~]# netstat -rn
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
128.17.75.0      128.17.75.20   255.255.255.0   UN        1500 0          0 eth0
default          128.17.75.98   0.0.0.0         UGN       1500 0          0 eth0
127.0.0.1        127.0.0.1      255.0.0.0       UH        3584 0          0 lo
128.17.75.20     127.0.0.1      255.255.255.0   UH        3584 0          0 lo
```

Если хост eggplant пожелает послать пакет хосту zucchini, (соответственно, в пакете будет указан отправитель - *128.17.75.20* и получатель - *128.17.75.37*),
протокол IP определит на основании таблицы маршрутизации, что оба хоста принадлежат одной сети и пошлет пакет прямо в сеть, где zucchini его получит.
Если более подробно сказать, то сетевая карта широковещательно кричит **ARP**-запросом "Кто такой IP *128.17.75.37*, это кричит *128.17.75.20*?".
Все машины, получившие данное послание - игнорируют его, а хост с адресом *128.17.75.37* отвечает "Это я и мой MAC-адрес такой-то...",
далее происходит соединение и обмен данными на основе **ARP** таблиц, в которых занесено соответствие IP-MAC адресов.
"Кричит", то есть этот пакет посылается всем хостам. Это происходит, потому что MAC-адрес получателя указан широковещательный адрес (*FF:FF:FF:FF:FF:FF*).
Такие пакеты получают все хосты сети.

Давайте рассмотрим ситуацию, когда хост eggplant хочет послать пакет хосту, например, pear или еще дальше?
В таком случае, получатель пакета будет - *128.17.112.21*, протокол IP попытается найти в таблице маршрутизации маршрут для сети *128.17.112*,
но данного маршрута в таблице нет, по этому будет выбран маршрут по умолчанию, шлюзом которого является papaya (*128.17.75.98*).
Получив пакет, papaya отыщет адрес назначения в своей таблице маршрутизации:
```
[root@papaya ~]# netstat -rn
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
128.17.75.0      128.17.75.98   255.255.255.0   UN        1500 0          0 eth0
128.17.112.0     128.17.112.3   255.255.255.0   UN        1500 0          0 eth1
default          128.17.112.40  0.0.0.0         UGN       1500 0          0 eth1
127.0.0.1        127.0.0.1      255.0.0.0       UH        3584 0          0 lo
128.17.75.98     127.0.0.1      255.255.255.0   UH        3584 0          0 lo
128.17.112.3     127.0.0.1      255.255.255.0   UH        3584 0          0 lo
```

Из примера видно, что papaya подключена к двум сетям *128.17.75*, через устройство eth0 и *128.17.112* через устройство eth1.
Маршрут по умолчанию, через хост pineapple, который в свою очередь, является шлюзом во внешнюю сеть.

Соответственно, получив пакет для pear, маршрутизатор papaya увидит, что адрес назначения принадлежит сети *128.17.112* и направит пакет в соответствии со второй записью в таблице маршрутизации.

Таким образом, пакеты передаются от маршрутизатора к маршрутизатору, пока не достигнут адреса назначения.

## Протокол **ICMP**
Протокол **ICMP** - это протокол уведомления об ошибках.

Для того чтобы маршрутизаторы могли оповещать узлы сети о
возникших ошибках или нештатных ситуациях, в стек TCP/IP введен
механизм рассылки специальных сообщений, который назвали протоколом
межсетевых управляющих сообщений (Internet Control Message Protocol, или
**ICMP**).
